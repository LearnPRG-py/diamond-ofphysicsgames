<!-- Achievement Top Bar Only - No Background, No Demo Content -->
<div class="achievement-bar" style="overflow-x: hidden" id="achievement-bar">
    <!-- Subtle particles -->
    <div class="bar-particles" id="bar-particles"></div>
    
    <!-- Left: Achievement Notifications -->
    <div class="achievement-notification">
        <div class="achievement-popup" id="achievement-popup">
            <div class="achievement-icon" id="popup-icon">üèÜ</div>
            <div class="achievement-text">
                <div class="achievement-title" id="popup-title">Achievement Get!</div>
                <div class="achievement-desc" id="popup-desc">You've earned points!</div>
            </div>
        </div>
    </div>
    
    <!-- Center: Achievements Page Button -->
    <div class="achievements-center">
        <a href="https://games.quarklearning.online/achievements.html" class="achievements-btn">
            üèÜ Achievements
        </a>
    </div>
    
    <!-- Right: Stats (Streak + Rank/Points) -->
    <div class="stats-section">
        <!-- Streak Display -->
        <div class="streak-display">
            <span class="streak-icon">üî•</span>
            <div class="streak-info">
                <div class="streak-number" id="streak-number">0</div>
                <div class="streak-label">streak</div>
            </div>
        </div>
        
        <!-- Rank Display -->
        <div class="rank-display">
            <div class="rank-main">
                <span class="rank-icon" id="rank-icon">üë§</span>
                <span class="rank-name" id="rank-name">New Student</span>
            </div>
            <div class="points-text" id="points-text">0 points</div>
        </div>
    </div>
</div>

<style>
/* Achievement Top Bar - Clean Version for Wix */
/* Apply box-sizing to everything */
*,
*::before,
*::after {
    box-sizing: border-box;
}

/* Ensure body doesn‚Äôt overflow horizontally */
body {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
}

/* Strict width control for achievement bar */
.achievement-bar {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box; /* Padding and border won't overflow */
}

.achievement-bar {
    width: 100%;
    height: 70px;
    background: linear-gradient(135deg, #0a0a0f 0%, #1a0a1f 50%, #0f0a1a 100%);
    border-bottom: 1px solid rgba(138, 43, 226, 0.3);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 30px;
    position: relative;
    overflow-x: hidden; /* Hide horizontal overflow */
    overflow-y: visible;
    box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    color: white;
}

/* Subtle particle background for the bar */
.bar-particles {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    pointer-events: none;
    opacity: 0.3;
}

.bar-particle {
    position: absolute;
    color: rgba(255, 255, 255, 0.4);
    font-size: 8px;
    animation: barFloat 8s ease-in-out infinite;
}

@keyframes barFloat {
    0%, 100% {
        transform: translateX(0px) translateY(0px);
        opacity: 0.2;
    }
    50% {
        transform: translateX(10px) translateY(-5px);
        opacity: 0.6;
    }
}

/* Left Section - Achievement Notification Area */
.achievement-notification {
    flex: 1;
    max-width: 300px;
    height: 50px;
    position: relative;
}

/* Minecraft-style Achievement Popup */
.achievement-popup {
    position: absolute;
    left: 0;
    top: 0;
    width: 280px;
    height: 50px;
    background: linear-gradient(135deg, #2d1810 0%, #3d2416 100%);
    border: 2px solid #8b4513;
    border-radius: 8px;
    display: flex;
    align-items: center;
    padding: 8px 12px;
    transform: translateX(-100%);
    transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    opacity: 0;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
}

.achievement-popup.show {
    transform: translateX(0);
    opacity: 1;
}

.achievement-icon {
    width: 32px;
    height: 32px;
    background: #4a4a4a;
    border: 1px solid #666;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    margin-right: 10px;
    flex-shrink: 0;
}

.achievement-text {
    flex: 1;
    min-width: 0;
}

.achievement-title {
    font-size: 12px;
    font-weight: 600;
    color: #ffff55;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.achievement-desc {
    font-size: 11px;
    color: #cccccc;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Center Section - Achievements Button */
.achievements-center {
    flex: 0 0 auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.achievements-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    padding: 12px 24px;
    border-radius: 25px;
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.achievements-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    text-decoration: none;
    color: white;
}

/* Right Section - Stats */
.stats-section {
    flex: 1;
    max-width: 300px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 25px;
    margin-left: -10px; /* Push it slightly to the left */
    overflow-x: hidden;
}

/* Streak Display - Horizontal */
.streak-display {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(255, 87, 34, 0.15);
    border: 1px solid rgba(255, 87, 34, 0.4);
    border-radius: 20px;
    padding: 8px 15px;
    transition: all 0.3s ease;
    min-width: 0;
    flex-shrink: 1;
}

.streak-display:hover {
    background: rgba(255, 87, 34, 0.2);
    transform: scale(1.05);
}

.streak-icon {
    font-size: 20px;
}

.streak-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1px;
}

.streak-number {
    font-size: 16px;
    font-weight: 700;
    color: #ff5722;
    line-height: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.streak-label {
    font-size: 10px;
    color: rgba(255, 255, 255, 0.7);
    line-height: 1;
}

/* Rank Display */
.rank-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    background: rgba(33, 150, 243, 0.15);
    border: 1px solid rgba(33, 150, 243, 0.4);
    border-radius: 15px;
    padding: 8px 15px;
    min-width: 100px;
    transition: all 0.3s ease;
    min-width: 0;
    flex-shrink: 1;
}

.rank-display:hover {
    background: rgba(33, 150, 243, 0.2);
    transform: scale(1.05);
}

.rank-main {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 2px;
}

.rank-icon {
    font-size: 18px;
}

.rank-name {
    font-size: 13px;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.95);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.points-text {
    font-size: 11px;
    color: rgba(255, 255, 255, 0.6);
    line-height: 1;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Responsive Design */
@media (max-width: 768px) {
    .achievement-bar {
        padding: 0 10px;
        height: 60px;
    }
    
    .stats-section {
        gap: 10px;
    }
    
    .achievements-btn {
        padding: 8px 16px;
        font-size: 12px;
    }
    
    .achievement-popup {
        max-width: 220px;
        height: 45px;
    }
    
    .rank-display, .streak-display {
        padding: 6px 8px;
    }
}

@media (max-width: 600px) {
    .achievement-bar {
        flex-wrap: wrap;
        height: auto;
        padding: 8px 10px;
        gap: 8px;
        min-height: 60px;
    }
    
    .achievement-notification {
        order: 2;
        max-width: 100%;
        width: 100%;
        flex-basis: 100%;
    }
    
    .achievements-center {
        order: 1;
        flex-basis: 100%;
        margin-bottom: 5px;
    }
    
    .stats-section {
        order: 3;
        justify-content: center;
        max-width: 100%;
        flex-basis: 100%;
    }
}
</style>

<script>
// Storage Keys matching your achievements system
const STORAGE_KEYS = {
    points: 'ach_points',
    streak: 'ach_streak'
};

// ---------------- LOCAL ENCRYPTION ---------------- //
let localSecret = null;

// Initialize local secret on first load
function initializeLocalSecret() {
    if (localSecret === null) {
        // Try to get existing secret from storage
        const existingSecret = getCookie('ach_local_secret');
        if (existingSecret) {
            localSecret = parseInt(existingSecret, 10);
        } else {
            // Generate new random secret (0-9999)
            localSecret = Math.floor(Math.random() * 10000);
            setCookie('ach_local_secret', String(localSecret), 2147483647);
        }
    }
    return localSecret;
}

// Encrypt a value using local secret
function encryptValue(value) {
    const secret = initializeLocalSecret();
    return (secret * secret) + (44 * secret) + value;
}

// Decrypt a value using local secret
function decryptValue(encryptedValue) {
    const secret = initializeLocalSecret();
    return encryptedValue - (secret * secret) - (44 * secret);
}

// Cookie helpers (scoped to .quarklearning.online)
function setCookie(name, value, days = 2147483647) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    const cookie = `${encodeURIComponent(name)}=${encodeURIComponent(String(value))}; Expires=${expires}; Path=/; Domain=.quarklearning.online; Secure; SameSite=None`;
    document.cookie = cookie;
}

function getCookie(name) {
    const cookies = document.cookie ? document.cookie.split('; ') : [];
    for (let i = 0; i < cookies.length; i++) {
        const parts = cookies[i].split('=');
        const key = decodeURIComponent(parts.shift());
        const val = parts.join('=');
        if (key === name) return decodeURIComponent(val);
    }
    return null;
}

function deleteCookie(name) {
    document.cookie = `${encodeURIComponent(name)}=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Path=/; Domain=.quarklearning.online; Secure; SameSite=None`;
}

// Achievement Thresholds
const RANK_THRESHOLDS = [
    { threshold: 50, name: "Getting Started", icon: "üåü" },
    { threshold: 200, name: "Point Collector", icon: "üíé" },
    { threshold: 500, name: "Rising Scholar", icon: "üìö" },
    { threshold: 1000, name: "Point Hoarder", icon: "üí∞" },
    { threshold: 5000, name: "Master", icon: "üëë" },
    { threshold: 10000, name: "Legendary", icon: "üèÜ" },
    { threshold: 50000, name: "HOW DID WE GET HERE?!", icon: "üöÄ" }
];

const DEFAULT_RANK = { name: "New Student", icon: "üë§" };

let pendingAchievements = [];
let isProcessingAchievements = false;

// Utility Functions
function getValue(key) {
    const raw = getCookie(STORAGE_KEYS[key]);
    
    if (!raw) return 0;
    
    // Decrypt the value for numeric stats
    const encryptedValue = parseInt(raw, 10);
    if (!Number.isFinite(encryptedValue)) return 0;
    
    try {
        return decryptValue(encryptedValue);
    } catch (error) {
        console.warn(`Failed to decrypt ${key}, returning 0:`, error);
        return 0;
    }
}

function setValue(key, val) {
    // Coerce to number and validate
    const numericVal = Number(val);
    if (!Number.isFinite(numericVal)) {
        console.warn(`Attempted to set ${key} to ${val}, which is not a finite number. Ignoring write.`);
        return;
    }

    // Encrypt the value before saving
    try {
        const encryptedValue = encryptValue(numericVal);
        setCookie(STORAGE_KEYS[key], String(encryptedValue), 2147483647);
        updateStatsDisplay();
    } catch (error) {
        console.error(`Failed to encrypt ${key}, saving unencrypted:`, error);
        setCookie(STORAGE_KEYS[key], String(numericVal), 2147483647);
        updateStatsDisplay();
    }
}

function getCurrentRank(points) {
    let currentRank = DEFAULT_RANK;
    for (const rank of RANK_THRESHOLDS) {
        if (points >= rank.threshold) {
            currentRank = rank;
        }
    }
    return currentRank;
}

function addNewAchievement(id, icon, title, description) {
    const achievement = { id, icon, title, description, timestamp: Date.now() };
    
    if (!pendingAchievements.find(ach => ach.id === id)) {
        pendingAchievements.push(achievement);
        
        if (document.hasFocus() && document.getElementById('achievement-popup') && !isProcessingAchievements) {
            processAchievementQueue();
        }
    }
}

function processAchievementQueue() {
    if (isProcessingAchievements || pendingAchievements.length === 0) {
        return;
    }
    
    isProcessingAchievements = true;
    const achievement = pendingAchievements.shift();
    showAchievementNotification(achievement.icon, achievement.title, achievement.description);
    
    setTimeout(() => {
        isProcessingAchievements = false;
        processAchievementQueue();
    }, 5000);
}

function createBarParticles() {
    const container = document.getElementById('bar-particles');
    if (!container) return;
    container.innerHTML = '';
    const particles = ['‚ú¶', '‚úß', '‚≠ê', '‚ú®'];
    for (let i = 0; i < 8; i++) {
        const particle = document.createElement('div');
        particle.className = 'bar-particle';
        particle.textContent = particles[Math.floor(Math.random() * particles.length)];
        particle.style.left = Math.random() * 100 + '%';
        particle.style.top = Math.random() * 70 + '%';
        particle.style.animationDelay = Math.random() * 8 + 's';
        particle.style.animationDuration = (6 + Math.random() * 4) + 's';
        container.appendChild(particle);
    }
}

function updateStatsDisplay() {
    const points = getValue('points');
    const streak = getValue('streak');
    const currentRank = getCurrentRank(points);
    
    const streakEl = document.getElementById('streak-number');
    if (streakEl) streakEl.textContent = streak;
    
    const rankIconEl = document.getElementById('rank-icon');
    const rankNameEl = document.getElementById('rank-name');
    const pointsEl = document.getElementById('points-text');
    
    if (rankIconEl) rankIconEl.textContent = currentRank.icon;
    if (rankNameEl) rankNameEl.textContent = currentRank.name;
    if (pointsEl) pointsEl.textContent = `${points.toLocaleString()} points`;
}

function showAchievementNotification(icon, title, description) {
    const popup = document.getElementById('achievement-popup');
    const iconEl = document.getElementById('popup-icon');
    const titleEl = document.getElementById('popup-title');
    const descEl = document.getElementById('popup-desc');
    
    if (!popup || !iconEl || !titleEl || !descEl) return;
    
    iconEl.textContent = icon;
    titleEl.textContent = title;
    descEl.textContent = description;
    
    popup.classList.add('show');
    setTimeout(() => {
        popup.classList.remove('show');
    }, 4000);
}

// ‚úÖ Initialization block with guard
if (!window.achievementBarInitialized) {
    window.achievementBarInitialized = true;

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize local encryption secret
        initializeLocalSecret();
        
        updateStatsDisplay();
        createBarParticles();
        if (typeof checkAchievementsAndUpdate === 'function') {
            setTimeout(() => {
                checkAchievementsAndUpdate();
            }, 100);
        }
        setTimeout(() => {
            processAchievementQueue();
        }, 500);
    });

    window.addEventListener('focus', function() {
        updateStatsDisplay();
        if (typeof checkAchievementsAndUpdate === 'function') {
            setTimeout(() => {
                checkAchievementsAndUpdate();
            }, 100);
        }
        setTimeout(() => {
            processAchievementQueue();
        }, 200);
    });
}

// ‚úÖ Expose functions globally
window.addNewAchievement = addNewAchievement;
window.getValue = getValue;
window.setValue = setValue;
window.updateStatsDisplay = updateStatsDisplay;
</script>